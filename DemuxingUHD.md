# How to Demux a UHD Blu-ray Disk

## Overview

Demuxing a UHD Blu-ray disc extracts individual streams (video, audio, subtitles, chapters, etc.) from the disc structure. Given the complexity of UHD Blu-rays and their frequent use of HEVC (H.265) video, specialized tools are essential. While eac3to is a robust tool for standard Blu-rays, DGDemux is better suited for UHD Blu-rays due to its precise handling of Dolby Vision metadata and seamless branching.

---

## Why DGDemux?

DGDemux is optimized for UHD Blu-rays, especially those containing Dolby Vision. Compared to other tools, it offers:

- Accurate extraction of Base Layer (BL) and Enhancement Layer (EL).
- Seamless integration with dovi_tool for handling Dolby Vision metadata.
- Proper processing of seamless branching playlists.
- Superior error detection for flawed discs.

---

## Setting Up DGDemux

### Installation

1. **Download DGDemux**:

   - Visit the [DGDemux website](https://rationalqm.us/dgdemux/dgdemux.html) to download the latest version.

2. **Install dovi_tool**:

   - Download dovi_tool from its [GitHub repository](https://github.com/quietvoid/dovi_tool).
   - Extract and ensure the executable is in your system path.

### Adding to System Path

- Add the DGDemux directory to your system path to make it accessible from any command prompt location.
- Search online for instructions on how to add directories to the system path for your operating system.

---

## Demuxing UHD Blu-rays

### Step 1: Analyze the Disc Structure with DGDemux

Before demuxing specific streams, use the `-d` option to analyze the full disc structure and gather playlist information. This is essential for identifying the correct playlist.

1. **Command to analyze the disc structure**:
   ```
   DGDemux -d "<FullPathToDecryptedDisc>"
   ```

   Example:
   ```
   DGDemux -d "D:\discs\MovieTitle"
   ```

   This command will display the list of playlists available on the disc, along with the associated chapter information for each.

2. **Interpret the output**:
   The output will list all playlists and the number of chapters each contains, like this:
   ```
   PlayLists:
       00800.mpls 02:45:49 [18 chapters]
       00816.mpls 00:12:59 [2 chapters]
       00810.mpls 00:11:41 [2 chapters]
   ```

   From this list, you can identify the playlist you want to demux. Typically, the main feature will be the playlist with the longest duration and the most chapters.

### Step 2: Demux Using DGDemux

Once you have the playlist identified, you can now use the `-i` option to specify the playlist and start the demuxing process.

1. **Basic Command**: To demux all streams (audio, video, subtitles, chapters) from the selected playlist:
   ```
   DGDemux -i "<FullPathToDecryptedDisc>\PLAYLIST\<PlaylistNumber>.mpls" -o "<OutputFolderPath>\<OutputFilePrefix>"
   ```

   Example:
   ```
   DGDemux -i "D:\discs\MovieTitle\BDMV\PLAYLIST\00001.mpls" -o "D:\output\MovieTitle"
   ```

2. **Demux Specific Streams**: If you want to extract only the video and audio tracks, use the `-demux` option to specify the PIDs:
   ```
   DGDemux -i "<FullPathToDecryptedDisc>\PLAYLIST\<PlaylistNumber>.mpls" -o "<OutputFolderPath>\<OutputFilePrefix>" -demux <PID1>,<PID2>
   ```

   Example (for audio PID 4352 and video PID 4113):
   ```
   DGDemux -i "D:\discs\MovieTitle\BDMV\PLAYLIST\00001.mpls" -o "D:\output\MovieTitle" -demux 4113,4352
   ```

3. **For Dolby Vision UHD Blu-rays**: Use the `-mergedv` or `-mergedv81` options to create merged streams with Dolby Vision metadata:
   - **Base + Enhancement Layer Merge**:
     ```
     DGDemux -i "<FullPathToDecryptedDisc>\PLAYLIST\<PlaylistNumber>.mpls" -o "<OutputFolderPath>\<OutputFilePrefix>" -mergedv
     ```
   - **Profile 8 Dolby Vision Merge** (if converting RPU to Profile 8):
     ```
     DGDemux -i "<FullPathToDecryptedDisc>\PLAYLIST\<PlaylistNumber>.mpls" -o "<OutputFolderPath>\<OutputFilePrefix>" -mergedv81
     ```

---

## Verifying Dolby Vision UHD Blu-ray Mastering

The purpose of this section is to ensure that the UHD Blu-ray disc is mastered correctly. A properly mastered disc will have matching RPU and scene-cut data when the Metadata Enhancement Layer (MEL) is merged with the Base Layer (BL) compared to the untouched EL.

### Step 1: Extract the Enhancement Layer (EL) RPU

Use **dovi_tool** to extract the Enhancement Layer (EL) and generate the RPU:

```
dovi_tool extract-rpu --input EL.hevc --output RPU_EL.bin
```

**Important**: The `EL.hevc` file might not actually be named `EL.hevc` and needs to be identified from the files created during the demuxing step. Typically, the EL file is the **second `.hevc` file** generated by DGDemux and is significantly smaller in size than the Base Layer (BL) `.hevc` file. Verify this by checking the file sizes in the output directory.

If you're unsure, compare the sizes of the `.hevc` files:
- The **larger file** corresponds to the Base Layer (BL).
- The **smaller file** corresponds to the Enhancement Layer (EL).

Once identified, substitute the correct filename for `EL.hevc` in the above command.


### Step 2: Compare EL RPU Data with the BL and EL Merge RPU

- Extract the RPU from the merged BL and EL file created by DGDemux:


```
dovi_tool extract-rpu --input merged_dovi.hevc --output RPU_MERGED.bin
```
The `merged_dovi.hevc` is created by DGDemux when selecting the `-mergedv` option.


- Compare the original EL data RPU with the merged BL and EL RPU:

```
diff RPU_EL.bin RPU_MERGED.bin
```
**Note** If you do not have diff avilable you can install git for windows
Once installed add `C:\Program Files\Git\usr\bin\` to your `PATH`, as it already ships with a diff executable and installs it in that folder.

If the RPU files match, the disc is mastered correctly, and the RPU can be injected into the Base Layer (BL) during the remuxing process.

If discrepancies are detected:

- Revisit the extraction or merging process to ensure no errors occurred.
- If issues persist, the disc may be poorly mastered. Consider obtaining a corrected release from another region or a replacement disc.


With MEL, converting the RPU from the EL to Profile 8 can resolve some issues caused by incorrect Profile 7 RPUs. Use the following command to create the Profile 8 RPU:

```
DGDemux -i "<FullPathToDecryptedDisc>\PLAYLIST<PlaylistNumber>.mpls" -o "<OutputFolderPath><OutputFilePrefix>" -mergedv81
```

### Check and Fix the Crop/Active Area

After creating the RPU, it’s important to verify the crop and active area of the video to ensure that no part of the image is inadvertently cut off or improperly displayed.

1. **Check the crop**: Ensure that the video crop is consistent with the original Blu-ray and hasn’t been accidentally altered.
2. **Fix the active area**: If necessary, adjust the active area to match the intended playback region.

#### Active Area Verification

The **active area** is defined by the following offsets:

- `active_area_left_offset`
- `active_area_right_offset`
- `active_area_top_offset`
- `active_area_bottom_offset`

These offsets indicate the area of the video that will be actively displayed. When using `dovi_tool info -i RPU.bin -f 1`, you can see the **Level 5 (L5)** data, including these offsets for a single frame, like this:

```json
{
  "Level5": {
    "active_area_left_offset": 0,
    "active_area_right_offset": 0,
    "active_area_top_offset": 276,
    "active_area_bottom_offset": 276
  }
}
```

### Is the active area the same across all frames?

In most cases, the active area remains the same across all frames of the video, especially if the content doesn't have dynamic framing or anamorphic scaling. However, to ensure this:

- **Check multiple frames**: If possible, verify the active area across different frames. If the offsets remain constant, then it’s safe to assume the active area is consistent across the entire video.

- **Scene Data**: The scene/shot count (e.g., "Scene/shot count: 2577") can be useful to determine if any changes occur in the active area during different scenes or shots. If the active area is changing dynamically, it would be reflected in the scene data.

- **Content Considerations**: For most standard content, the active area should be consistent. Dynamic cropping or changes in active area are uncommon unless specific content adjustments are made.

By confirming the consistency of the active area across all frames, you ensure that the final remux will maintain the correct display of the content without any unintended cropping or stretching.

---

## Conclusion

DGDemux is the go-to tool for demuxing UHD Blu-ray discs, offering unmatched accuracy and reliability for Dolby Vision content and seamless branching. By following this guide, you can confidently extract high-quality streams ready for further processing or remuxing. For advanced Dolby Vision handling, integrate **dovi_tool** into your workflow to ensure flawless metadata management.
